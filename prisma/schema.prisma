// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int         @id @default(autoincrement())
  name       String
  backups    Backup[]
  shareLinks ShareLink[]

  firstSubscribed DateTime?
  subscribedSince DateTime?
  lifetime        Boolean   @default(false)

  discordId         BigInt?           @unique
  discordUser       DiscordUser?      @relation(fields: [discordId], references: [id], onDelete: SetNull)
  guildedId         String?           @unique
  guildedUser       GuildedUser?      @relation(fields: [guildedId], references: [id], onDelete: SetNull)
  messageLogEntries MessageLogEntry[]
}

model DiscordUser {
  id            BigInt          @id
  name          String
  globalName    String?
  discriminator String
  avatar        String?
  members       DiscordMember[]

  user User?
}

model GuildedUser {
  id        String  @id
  name      String
  avatarUrl String?

  user User?
}

model DiscordGuild {
  id   BigInt  @id
  name String
  icon String?

  roles    DiscordRole[]
  members  DiscordMember[]
  backups  Backup[]
  webhooks Webhook[]
}

model DiscordRole {
  id      BigInt       @id
  guildId BigInt
  guild   DiscordGuild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  name         String
  color        Int     @default(0)
  permissions  BigInt  @default(0)
  icon         String?
  unicodeEmoji String?
  position     Int
  hoist        Boolean @default(false)
  managed      Boolean @default(false)
  mentionable  Boolean @default(false)

  @@unique([guildId, id])
}

model DiscordMember {
  userId  BigInt
  guildId BigInt

  user  DiscordUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild DiscordGuild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId])
}

model GuildedServer {
  id        String  @id
  name      String
  avatarUrl String?

  backups  Backup[]
  webhooks Webhook[]
}

model ShareLink {
  id        Int      @id @default(autoincrement())
  shareId   String
  createdAt DateTime @default(now())
  expiresAt DateTime
  origin    String?

  userId Int?
  user   User? @relation(fields: [userId], references: [id])
}

model Backup {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  dataVersion String
  data        Json

  ownerId Int
  owner   User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  guilds  DiscordGuild[]
  servers GuildedServer[]
}

model Webhook {
  platform  String
  id        String  @id
  token     String?
  name      String
  avatar    String?
  channelId String

  discordGuildId  BigInt?
  discordGuild    DiscordGuild?  @relation(fields: [discordGuildId], references: [id])
  guildedServerId String?
  guildedServer   GuildedServer? @relation(fields: [guildedServerId], references: [id])

  messageLogEntries MessageLogEntry[]
}

model MessageLogEntry {
  id   Int    @id @default(autoincrement())
  type String // send, edit, delete

  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id])
  channelId String
  messageId String
  threadId  String?

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  notifiedEveryoneHere Boolean  @default(false)
  notifiedRoles        String[]
  notifiedUsers        String[]
  hasContent           Boolean  @default(false)
  embedCount           Int      @default(0)
}
